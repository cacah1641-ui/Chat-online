<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat User A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        #chatContainer { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: rgba(229, 221, 213, 0.9); }
        .bubble { position: relative; padding: 6px 10px; font-size: 14.2px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); max-width: 85%; word-wrap: break-word; border-radius: 8px; margin-bottom: 4px; }
        .mine { background: #dcf8c6; align-self: flex-end; }
        .theirs { background: white; align-self: flex-start; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .online { background-color: #25d366; }
        .offline { background-color: #9ca3af; }
        .recording-active { background-color: #ea4335 !important; transform: scale(1.2); transition: 0.3s; }
    </style>
</head>
<body class="flex items-center justify-center">

<div class="w-full max-w-lg h-screen md:h-[95vh] flex flex-col shadow-2xl bg-[#e5ddd5] relative">
    <div class="bg-[#075e54] text-white p-3 flex items-center justify-between z-10 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center font-bold text-lg">B</div>
            <div class="leading-tight">
                <h2 class="font-semibold text-[15px]">User B</h2>
                <div class="flex items-center">
                    <span id="statusDot" class="status-dot offline"></span>
                    <p id="statusText" class="text-[11px] text-[#b1d4d0]">Offline</p>
                </div>
            </div>
        </div>
        <div class="flex gap-5 items-center pr-2">
            <button onclick="startCall(true)"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
            <button onclick="clearHistory()" class="text-[10px] bg-red-600/30 px-1 rounded">Clear</button>
        </div>
    </div>

    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
        <div id="chatBox" class="flex flex-col space-y-2"></div>
    </div>

    <div id="emojiPanel" class="hidden grid grid-cols-8 gap-2 p-3 bg-gray-100 border-t overflow-y-auto max-h-40"></div>
    <div class="bg-[#f0f0f0] p-2 flex items-center gap-2">
        <div class="flex bg-white rounded-full flex-1 items-center px-3 shadow-sm">
            <button onclick="toggleEmoji()" class="p-1 text-gray-500">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5s.67 1.5 1.5 1.5zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
            </button>
            <input type="text" id="msgInput" placeholder="Ketik pesan" class="flex-1 bg-transparent p-2.5 outline-none">
        </div>
        <button onclick="send()" class="bg-[#00a884] text-white p-3.5 rounded-full shadow-md">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>
</div>

<script>
    const SAYA = "ID-USER-A-99"; const DIA = "ID-USER-B-99"; const ROOM = "Utama";
    let lastMsgCount = 0;

    async function sendHeartbeat() {
        const res = await fetch('/api/heartbeat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: SAYA, room: ROOM })
        });
        const data = await res.json();
        document.getElementById('statusDot').className = `status-dot ${data.onlineCount > 1 ? 'online' : 'offline'}`;
        document.getElementById('statusText').innerText = data.onlineCount > 1 ? `Online (${data.onlineCount} User)` : "Offline";
    }

    async function fetchMessages() {
        const res = await fetch(`/api/messages?room=${ROOM}`);
        const data = await res.json();
        if(data.length !== lastMsgCount) {
            const box = document.getElementById('chatBox'); box.innerHTML = '';
            data.forEach(m => {
                const side = m.senderId === SAYA ? 'mine' : 'theirs';
                const d = document.createElement('div');
                d.className = `bubble ${side}`;
                d.innerHTML = `<p>${m.text}</p><span class="text-[8px] opacity-50 block text-right">${m.time}</span>`;
                box.appendChild(d);
            });
            document.getElementById('chatContainer').scrollTop = box.scrollHeight;
            lastMsgCount = data.length;
        }
    }

    async function send() {
        const input = document.getElementById('msgInput');
        if(!input.value) return;
        await fetch('/api/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ room: ROOM, senderId: SAYA, text: input.value })
        });
        input.value = ''; fetchMessages();
    }

    function toggleEmoji() {
        const p = document.getElementById('emojiPanel'); p.classList.toggle('hidden');
        if(p.innerHTML === "") {
            ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ‘','ðŸ™','â¤ï¸','ðŸ”¥','âœ¨'].forEach(e => {
                const s = document.createElement('span'); s.innerText = e; s.className="cursor-pointer text-2xl p-2";
                s.onclick = () => { document.getElementById('msgInput').value += e; }; p.appendChild(s);
            });
        }
    }

    setInterval(fetchMessages, 3000); setInterval(sendHeartbeat, 5000);
    window.onload = fetchMessages;
</script>
</body>
</html>