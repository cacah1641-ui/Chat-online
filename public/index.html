<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat User A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        #chatContainer { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-blend-mode: overlay; background-color: rgba(229, 221, 213, 0.9); 
        }
        .bubble { position: relative; padding: 6px 10px; font-size: 14.2px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); max-width: 85%; word-wrap: break-word; border-radius: 8px; margin-bottom: 4px; }
        .mine { background: #dcf8c6; align-self: flex-end; }
        .theirs { background: white; align-self: flex-start; }
        #callOverlay { display: none; position: fixed; inset: 0; background: rgba(7, 94, 84, 0.98); z-index: 100; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; display: none; }
        #localVideo { width: 100px; height: 140px; position: absolute; top: 20px; right: 20px; border: 2px solid white; border-radius: 10px; object-fit: cover; z-index: 110; display: none; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .online { background-color: #25d366; }
        .offline { background-color: #9ca3af; }
        .recording-active { background-color: #ea4335 !important; transform: scale(1.2); transition: 0.3s; }
    </style>
</head>
<body class="flex items-center justify-center">

<div class="w-full max-w-lg h-screen md:h-[95vh] flex flex-col shadow-2xl bg-[#e5ddd5] relative">
    <div class="bg-[#075e54] text-white p-3 flex items-center justify-between z-10 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center font-bold text-lg shadow-sm">B</div>
            <div class="leading-tight">
                <h2 class="font-semibold text-[15px]">User B</h2>
                <div class="flex items-center">
                    <span id="statusDot" class="status-dot offline"></span>
                    <p id="statusText" class="text-[11px] text-[#b1d4d0]">Offline</p>
                </div>
            </div>
        </div>
        <div class="flex gap-5 items-center pr-2">
            <button onclick="startCall(true)" class="opacity-90 hover:opacity-100">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
            </button>
            <button onclick="startCall(false)" class="opacity-90 hover:opacity-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
            </button>
            <button onclick="clearHistory()" class="text-[11px] bg-red-600/30 px-2 py-1 rounded">Hapus</button>
        </div>
    </div>

    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
        <div id="chatBox" class="flex flex-col space-y-2"></div>
    </div>

    <div id="previewArea" class="hidden px-4 py-3 bg-white border-t flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img id="imgPreview" class="h-16 w-16 object-cover rounded-md border">
            <p class="text-xs text-gray-500 italic">Siap kirim...</p>
        </div>
        <button onclick="clearPreview()" class="text-red-600 font-bold text-xs">BATAL</button>
    </div>

    <div id="emojiPanel" class="hidden grid grid-cols-8 gap-2 p-3 bg-gray-100 border-t overflow-y-auto max-h-40"></div>

    <div class="bg-[#f0f0f0] p-2 flex items-center gap-2">
        <div class="flex bg-white rounded-full flex-1 items-center px-3 shadow-sm">
            <button onclick="toggleEmoji()" class="p-1 text-gray-500 hover:text-[#075e54]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5s.67 1.5 1.5 1.5zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
            </button>
            <input type="text" id="msgInput" placeholder="Ketik pesan" class="flex-1 bg-transparent p-2.5 outline-none text-[15px]">
            <label class="cursor-pointer text-gray-500 p-1 hover:text-[#075e54]">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(event)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </label>
            <button onclick="openCamera()" class="p-1 text-gray-500 hover:text-[#075e54]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            </button>
        </div>
        <button id="btnVN" onmousedown="startRecording()" onmouseup="stopRecording()" class="bg-[#00a884] text-white p-3.5 rounded-full shadow-md">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <button onclick="send()" class="hidden bg-[#00a884] text-white p-3.5 rounded-full shadow-md" id="btnSend">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>

    <div id="callOverlay">
        <div class="text-center mb-10">
            <div class="w-28 h-28 bg-orange-500 rounded-full mx-auto mb-6 flex items-center justify-center text-5xl font-bold shadow-2xl">B</div>
            <h2 class="text-3xl font-light">User B</h2>
            <p id="callTypeLabel" class="text-green-300 mt-2">Menghubungkan...</p>
        </div>
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
        <button onclick="endCall()" class="bg-red-600 p-5 rounded-full text-white mt-10 shadow-xl">
             <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.984.984 0 01-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
        </button>
    </div>
</div>

<div id="cameraArea" class="hidden fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center">
    <video id="photoVideo" class="max-w-full" autoplay playsinline></video>
    <div class="flex gap-10 mt-10">
        <button onclick="closeCamera()" class="text-white text-lg font-semibold">Batal</button>
        <button onclick="takePhoto()" class="bg-white p-8 rounded-full border-4 border-gray-400"></button>
        <div class="w-10"></div>
    </div>
</div>

<script>
    const SAYA = "ID-USER-A-99"; 
    const DIA  = "ID-USER-B-99";
    const ROOM = "Utama";
    let peer = new Peer(SAYA), currentCall, selectedFile = null, streamObj = null;
    let mediaRecorder, audioChunks = [];
    let lastMsgCount = 0;

    // --- LOGIKA SERVER ---
    async function fetchMessages() {
        try {
            const res = await fetch(`/api/messages?room=${ROOM}`);
            const data = await res.json();
            if(data.length !== lastMsgCount) {
                renderMessages(data);
                lastMsgCount = data.length;
            }
        } catch (e) {}
    }

    async function sendToServer(payload) {
        await fetch('/api/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        fetchMessages();
    }

    async function sendHeartbeat() {
        try {
            const res = await fetch('/api/heartbeat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId: SAYA, room: ROOM })
            });
            const data = await res.json();
            const isOnline = data.onlineCount > 1;
            document.getElementById('statusDot').className = `status-dot ${isOnline ? 'online' : 'offline'}`;
            document.getElementById('statusText').innerText = isOnline ? "Online" : "Offline";
        } catch (e) {}
    }

    function renderMessages(msgs) {
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
        msgs.forEach(m => {
            const side = m.senderId === SAYA ? 'mine' : 'theirs';
            const d = document.createElement('div');
            d.className = `bubble ${side}`;
            let html = '';
            if(m.image) html += `<img src="${m.image}" class="rounded-lg mb-1 max-w-full">`;
            if(m.audio) html += `<audio src="${m.audio}" controls class="w-48 h-10 mb-1"></audio>`;
            if(m.text) html += `<p>${m.text}</p>`;
            d.innerHTML = `${html} <span class="text-[8px] opacity-50 block text-right">${m.time}</span>`;
            box.appendChild(d);
        });
        document.getElementById('chatContainer').scrollTop = box.scrollHeight;
    }

    // --- UI LOGIC ---
    const msgInput = document.getElementById('msgInput');
    msgInput.addEventListener('input', () => {
        const showSend = msgInput.value.trim() !== "" || selectedFile !== null;
        document.getElementById('btnVN').classList.toggle('hidden', showSend);
        document.getElementById('btnSend').classList.toggle('hidden', !showSend);
    });

    function send() {
        if(!msgInput.value.trim() && !selectedFile) return;
        sendToServer({
            room: ROOM, senderId: SAYA, text: msgInput.value,
            image: selectedFile ? selectedFile.content : null
        });
        msgInput.value = '';
        clearPreview();
        msgInput.dispatchEvent(new Event('input'));
    }

    // --- VOICE NOTE ---
    async function startRecording() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(s);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const r = new FileReader();
                r.readAsDataURL(blob);
                r.onloadend = () => { sendToServer({ room: ROOM, senderId: SAYA, audio: r.result }); };
                s.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start();
            document.getElementById('btnVN').classList.add('recording-active');
        } catch (err) { alert("Mic error"); }
    }
    function stopRecording() { if(mediaRecorder && mediaRecorder.state !== 'inactive'){ mediaRecorder.stop(); document.getElementById('btnVN').classList.remove('recording-active'); }}

    // --- CAMERA & FILE ---
    async function openCamera() {
        streamObj = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('photoVideo').srcObject = streamObj;
        document.getElementById('cameraArea').classList.remove('hidden');
    }
    function takePhoto() {
        const v = document.getElementById('photoVideo');
        const c = document.createElement('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        selectedFile = { content: c.toDataURL('image/jpeg') };
        document.getElementById('imgPreview').src = selectedFile.content;
        document.getElementById('previewArea').classList.remove('hidden');
        closeCamera();
        msgInput.dispatchEvent(new Event('input'));
    }
    function closeCamera() { if(streamObj) streamObj.getTracks().forEach(t=>t.stop()); document.getElementById('cameraArea').classList.add('hidden'); }
    function handleFile(e) {
        const r = new FileReader();
        r.onload = ev => {
            selectedFile = { content: ev.target.result };
            document.getElementById('imgPreview').src = ev.target.result;
            document.getElementById('previewArea').classList.remove('hidden');
            msgInput.dispatchEvent(new Event('input'));
        };
        r.readAsDataURL(e.target.files[0]);
    }
    function clearPreview() { selectedFile = null; document.getElementById('previewArea').classList.add('hidden'); msgInput.dispatchEvent(new Event('input')); }

    // --- PEERJS CALL ---
    async function startCall(isVideo) {
        const s = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
        showCallUI(isVideo);
        document.getElementById('localVideo').srcObject = isVideo ? s : null;
        const call = peer.call(DIA, s, { metadata: { isVideo } });
        setupCallEvents(call, isVideo);
    }
    peer.on('call', async call => {
        const isVideo = call.options.metadata.isVideo;
        if(confirm("Terima panggilan?")) {
            const s = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            showCallUI(isVideo);
            call.answer(s);
            setupCallEvents(call, isVideo);
        }
    });
    function showCallUI(isVideo) {
        document.getElementById('callOverlay').style.display = 'flex';
        document.getElementById('localVideo').style.display = isVideo ? 'block' : 'none';
        document.getElementById('remoteVideo').style.display = isVideo ? 'block' : 'none';
    }
    function setupCallEvents(call, isVideo) {
        currentCall = call;
        call.on('stream', rem => {
            document.getElementById('remoteVideo').srcObject = rem;
            if(!isVideo){ let a = new Audio(); a.srcObject = rem; a.play(); }
        });
        call.on('close', () => {
            document.getElementById('callOverlay').style.display = 'none';
            if(document.getElementById('localVideo').srcObject) document.getElementById('localVideo').srcObject.getTracks().forEach(t=>t.stop());
        });
    }
    function endCall() { if(currentCall) currentCall.close(); }

    // --- EMOJI & CLEAR ---
    function toggleEmoji() {
        const p = document.getElementById('emojiPanel');
        p.classList.toggle('hidden');
        if(p.innerHTML === "") {
            ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ‘','ðŸ™','â¤ï¸','ðŸ”¥','ðŸ˜­','ðŸ˜Ž','âœ¨'].forEach(e => {
                const s = document.createElement('span'); s.innerText = e; s.className="cursor-pointer text-2xl p-2";
                s.onclick = () => { msgInput.value += e; msgInput.dispatchEvent(new Event('input')); };
                p.appendChild(s);
            });
        }
    }
    async function clearHistory() {
        if(confirm("Hapus history?")) {
            await fetch('/api/messages', { method: 'DELETE' });
            fetchMessages();
        }
    }

    setInterval(fetchMessages, 3000);
    setInterval(sendHeartbeat, 5000);
    window.onload = fetchMessages;
</script>
</body>
</html>