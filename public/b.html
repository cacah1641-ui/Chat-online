<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat User B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        #chatContainer { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: rgba(229, 221, 213, 0.9); }
        .bubble { position: relative; padding: 6px 12px; font-size: 14.5px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); max-width: 85%; word-wrap: break-word; border-radius: 8px; margin-bottom: 4px; }
        .mine { background: #dcf8c6; align-self: flex-end; }
        .theirs { background: white; align-self: flex-start; }
        .recording-active { background-color: #ea4335 !important; transform: scale(1.1); transition: 0.3s; }
        /* Scrollbar styling untuk Emoji Panel */
        #emojiPanel::-webkit-scrollbar { width: 4px; }
        #emojiPanel::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center">

<div class="w-full max-w-md h-screen md:h-[95vh] flex flex-col shadow-2xl bg-[#e5ddd5] relative">
    <div class="bg-[#075e54] text-white p-3 flex items-center justify-between z-10 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center font-bold text-lg">A</div>
            <div>
                <h2 class="font-semibold text-[15px]">User A</h2>
                <div class="flex items-center gap-1">
                    <div id="statusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <p id="statusText" class="text-[11px] text-[#b1d4d0]">Offline</p>
                </div>
            </div>
        </div>
        <button onclick="clearHistory()" class="text-[10px] bg-red-600/20 px-2 py-1 rounded hover:bg-red-600/40">Hapus Chat</button>
    </div>

    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
        <div id="chatBox" class="flex flex-col space-y-2"></div>
    </div>

    <div id="emojiPanel" class="hidden grid grid-cols-8 gap-1 p-2 bg-white border-t overflow-y-auto max-h-40 shadow-inner"></div>

    <div class="bg-[#f0f0f0] p-2 flex items-center gap-2">
        <div class="flex bg-white rounded-full flex-1 items-center px-3 shadow-sm">
            <button onclick="toggleEmoji()" class="p-1 text-gray-500 hover:text-[#075e54]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5s.67 1.5 1.5 1.5zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
            </button>
            
            <input type="text" id="msgInput" placeholder="Ketik pesan" class="flex-1 bg-transparent p-2.5 outline-none text-[15px]">
            
            <label class="cursor-pointer text-gray-500 p-1 hover:text-[#075e54]">
                <input type="file" id="fileInp" class="hidden" onchange="sendFile(this)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </label>

            <button class="p-1 text-gray-500 hover:text-[#075e54]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            </button>
        </div>
        
        <button id="micBtn" onmousedown="startVN()" onmouseup="stopVN()" class="bg-[#00a884] text-white p-3.5 rounded-full shadow-md active:scale-95 transition">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>

        <button onclick="sendText()" class="bg-[#00a884] text-white p-3.5 rounded-full shadow-md active:scale-95 transition">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
    </div>
</div>

<script>
    const SAYA = "B", DIA = "A", ROOM = "Utama";
    let mediaRecorder, chunks = [];
    const emojiList = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜…','ðŸ˜‚','ðŸ¤£','ðŸ˜Š','ðŸ˜','ðŸ˜˜','ðŸ‘','ðŸ™Œ','ðŸ™','ðŸ”¥','âœ¨','â¤ï¸'];

    async function fetchMsg() {
        try {
            const res = await fetch(`/api/messages?room=${ROOM}`);
            const data = await res.json();
            const box = document.getElementById('chatBox');
            box.innerHTML = data.map(m => `
                <div class="bubble ${m.senderId === SAYA ? 'mine' : 'theirs'}">
                    ${m.image ? (m.image.includes('video') ? `<video src="${m.image}" controls class="max-w-full rounded mb-1"></video>` : `<img src="${m.image}" class="max-w-full rounded mb-1">`) : ''}
                    ${m.audio ? `<audio src="${m.audio}" controls class="w-44 mb-1"></audio>` : ''}
                    ${m.text ? `<p>${m.text}</p>` : ''}
                    <span class="text-[9px] block text-right opacity-50 mt-1">${m.time}</span>
                </div>
            `).join('');
            document.getElementById('chatContainer').scrollTop = box.scrollHeight;
        } catch (e) {}
    }

    async function sendText() {
        const inp = document.getElementById('msgInput');
        if(!inp.value.trim()) return;
        await fetch('/api/messages', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ room: ROOM, senderId: SAYA, text: inp.value }) 
        });
        inp.value = '';
        document.getElementById('emojiPanel').classList.add('hidden');
        fetchMsg();
    }

    async function sendFile(inp) {
        if(!inp.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            await fetch('/api/messages', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ room: ROOM, senderId: SAYA, image: e.target.result }) 
            });
            fetchMsg();
        };
        reader.readAsDataURL(inp.files[0]);
    }

    async function startVN() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const r = new FileReader();
                r.readAsDataURL(blob);
                r.onloadend = async () => {
                    await fetch('/api/messages', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ room: ROOM, senderId: SAYA, audio: r.result }) 
                    });
                    fetchMsg();
                };
            };
            mediaRecorder.start();
            document.getElementById('micBtn').classList.add('recording-active');
        } catch (e) { alert("Mic tidak diakses"); }
    }

    function stopVN() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('micBtn').classList.remove('recording-active');
        }
    }

    function toggleEmoji() {
        const p = document.getElementById('emojiPanel');
        p.classList.toggle('hidden');
        if(p.innerHTML === "") {
            emojiList.forEach(e => {
                const btn = document.createElement('button');
                btn.className = "text-2xl p-1 hover:bg-gray-100 rounded";
                btn.innerText = e;
                btn.onclick = () => { document.getElementById('msgInput').value += e; };
                p.appendChild(btn);
            });
        }
    }

    async function clearHistory() {
        if(confirm("Hapus semua pesan?")) {
            await fetch('/api/messages', { method: 'DELETE' });
            fetchMsg();
        }
    }

    setInterval(async () => {
        const res = await fetch('/api/heartbeat', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ userId: SAYA, room: ROOM }) 
        });
        const data = await res.json();
        document.getElementById('statusDot').className = `w-2 h-2 rounded-full ${data.onlineCount > 1 ? 'bg-green-400' : 'bg-gray-400'}`;
        document.getElementById('statusText').innerText = data.onlineCount > 1 ? "Online" : "Offline";
        fetchMsg();
    }, 3000);

    window.onload = fetchMsg;
</script>
</body>
</html>
